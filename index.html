<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修复后的视频播放器</title>
    <script src="https://cdn.tailwindcss.com" async></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#1E40AF',
                        error: '#EF4444',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .video-card-hover {
                @apply transition-all duration-300 hover:shadow-xl hover:-translate-y-1 will-change-transform cursor-pointer;
            }
            .play-overlay {
                @apply opacity-0 hover:opacity-100 transition-opacity duration-300;
            }
            .error-message {
                @apply absolute inset-0 bg-gray-100 dark:bg-gray-800 flex flex-col items-center justify-center p-2 text-center hidden;
            }
            .grid-4x4 {
                @apply grid-cols-4;
            }
            .grid-1x16 {
                @apply grid-cols-1;
            }
            .grid-2x8 {
                @apply grid-cols-2;
            }
            .backdrop-blur {
                backdrop-filter: blur(8px);
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-inter text-gray-800">
    <!-- 顶部重新加载按钮 -->
    <header class="sticky top-0 z-30 bg-white shadow-sm py-3 px-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">视频播放器</h1>
            <button id="top-retry-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors hidden">
                <i class="fa fa-refresh mr-1"></i> 重新加载封面
            </button>
        </div>
    </header>

    <!-- 视频播放器模态框 -->
    <div id="video-modal" class="fixed inset-0 bg-black z-50 hidden flex-col">
        <!-- 视频头部控制区 -->
        <div class="flex justify-between items-center p-4 bg-gradient-to-b from-black/80 to-transparent text-white z-10">
            <h2 id="modal-title" class="text-xl font-semibold truncate max-w-[70%]"></h2>
            <button id="close-modal" class="w-10 h-10 rounded-full bg-black/30 backdrop-blur flex items-center justify-center hover:bg-black/50 transition-colors">
                <i class="fa fa-times"></i>
            </button>
        </div>
        
        <!-- 视频播放区 -->
        <div class="flex-1 relative">
            <!-- 视频播放错误提示 -->
            <div id="video-error" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center text-white hidden z-20">
                <i class="fa fa-exclamation-circle text-error text-4xl mb-4"></i>
                <p class="text-xl font-medium mb-2">视频播放失败</p>
                <p id="video-error-message" class="text-gray-300 mb-6 text-center px-4">无法加载视频，请稍后重试</p>
                <button id="retry-video" class="px-6 py-2 bg-primary hover:bg-secondary rounded-lg transition-colors">
                    <i class="fa fa-refresh mr-1"></i> 重试
                </button>
            </div>
            
            <video id="video-player" class="absolute inset-0 w-full h-full object-contain" controls>
                您的浏览器不支持HTML5视频播放
            </video>
            <div id="loading-indicator" class="hidden absolute inset-0 flex items-center justify-center bg-black/30 z-10">
                <div class="w-16 h-16 border-4 border-primary/30 border-t-primary rounded-full animate-spin"></div>
            </div>
        </div>
    </div>

    <!-- 视频列表 -->
    <div class="container mx-auto px-4 py-8">
        <div id="video-grid" class="grid gap-4">
            <!-- 视频卡片将通过JavaScript动态生成 -->
        </div>
        <!-- 全局加载状态指示器 -->
        <div id="global-loading" class="mt-8 text-center hidden">
            <p class="text-gray-600">
                <span id="loading-text">正在加载封面图片</span> 
                <span id="loading-progress">0</span>/<span id="total-items">0</span>
            </p>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                <div id="loading-bar" class="bg-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <script>
        // 缓存DOM元素和类名常量
        const DOM = {
            videoGrid: document.getElementById('video-grid'),
            videoModal: document.getElementById('video-modal'),
            videoPlayer: document.getElementById('video-player'),
            modalTitle: document.getElementById('modal-title'),
            closeModal: document.getElementById('close-modal'),
            loadingIndicator: document.getElementById('loading-indicator'),
            globalLoading: document.getElementById('global-loading'),
            loadingProgress: document.getElementById('loading-progress'),
            totalItems: document.getElementById('total-items'),
            loadingBar: document.getElementById('loading-bar'),
            loadingText: document.getElementById('loading-text'),
            topRetryBtn: document.getElementById('top-retry-btn'),
            videoError: document.getElementById('video-error'),
            videoErrorMessage: document.getElementById('video-error-message'),
            retryVideo: document.getElementById('retry-video')
        };
        
        const CLASS = {
            hidden: 'hidden',
            videoCard: 'video-card-hover',
            coverLoading: 'cover-loading',
            errorMessage: 'error-message',
            errorReason: 'error-reason',
            grid4x4: 'grid-4x4',
            grid1x16: 'grid-1x16',
            grid2x8: 'grid-2x8'
        };

        // 视频数据
        const videos = [
            { id: 1, title: "空悲切", url: "https://d.feiliupan.com/t/127891246667534336/konbeiqie.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/konbeiqie.jpg" },
            { id: 2, title: "旧时的福家拳", url: "https://d.feiliupan.com/t/127891246667534336/Fujiaquan.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/fujiaquan.jpg" },
            { id: 3, title: "神经班", url: "https://d.feiliupan.com/t/127891246667534336/sjban.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/sjban.jpg" },
            { id: 4, title: "妖娆", url: "https://d.feiliupan.com/t/127891246667534336/yaorao.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/yaorao.jpg" },
            { id: 5, title: "缘分本就稀薄寡淡 多是清尘浊水后会无期", url: "https://d.feiliupan.com/t/127891246667534336/yuanfen.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/yuanfen.jpg" },
            { id: 6, title: "全场最佳", url: "https://d.feiliupan.com/t/127891246667534336/quanchangzuijia.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/quanchangzuijia.jpg" },
            { id: 7, title: "期待本就是很无力的东西", url: "https://d.feiliupan.com/t/127891246667534336/qiedaiwuli.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/qiedaiwuli.jpg" },
            { id: 8, title: "他还在", url: "https://d.feiliupan.com/t/127891246667534336/tahaizai.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/tahaizai.jpg" },
            { id: 9, title: "最特别的老师", url: "https://d.feiliupan.com/t/127891246667534336/tebiedeDog.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/tebiedeDog.jpg" },
            { id: 10, title: "他还是来了", url: "https://d.feiliupan.com/t/127891246667534336/tahaisilaile.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/tahaisilaile.jpg" },
            { id: 11, title: "肚子越大的人跑步越快", url: "https://d.feiliupan.com/t/127891246667534336/dudapaokuai.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/dudapaokuai.jpg" },
            { id: 12, title: "权威", url: "https://d.feiliupan.com/t/127891246667534336/quanwei.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/quanwei.jpg" },
            { id: 13, title: "福拳", url: "https://d.feiliupan.com/t/127891246667534336/fuquan.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/fuquan.jpg" },
            { id: 14, title: "我们都太年轻了，不知道福高肚大", url: "https://d.feiliupan.com/t/127891246667534336/womendoutainianqinle.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/womendoutainianqinle.jpg" },
            { id: 15, title: "福哥对不起", url: "https://d.feiliupan.com/t/127891246667534336/fuge520.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/fuge520.jpg" },
            { id: 16, title: "戒了烟我不习惯，没有你我怎么办", url: "https://d.feiliupan.com/t/127891246667534336/jieyan.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/jieyan.jpg" }
        ];

        // 当前播放的视频信息
        let currentVideo = null;
        
        // 存储所有图片元素引用和加载状态
        let allImages = [];
        let failedImages = [];
        let currentLoadIndex = 0;
        let retryAttempts = 0;
        const maxRetryAttempts = 2;
        const loadDelay = 500;
        const retryDelay = 3000;

        // 根据屏幕比例确定布局
        function determineLayout() {
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const aspectRatio = windowWidth / windowHeight;
            
            if (aspectRatio > 1.65) {
                return { columns: 4, name: "4x4" };
            } else if (aspectRatio < 0.65) {
                return { columns: 1, name: "1x16" };
            } else {
                return { columns: 2, name: "2x8" };
            }
        }

        // 应用布局
        function applyLayout() {
            const layout = determineLayout();
            
            DOM.videoGrid.classList.remove(CLASS.grid4x4, CLASS.grid1x16, CLASS.grid2x8);
            
            if (layout.columns === 4) {
                DOM.videoGrid.classList.add(CLASS.grid4x4);
            } else if (layout.columns === 1) {
                DOM.videoGrid.classList.add(CLASS.grid1x16);
            } else {
                DOM.videoGrid.classList.add(CLASS.grid2x8);
            }
            
            adjustCardStyles(layout.columns);
        }

        // 调整卡片样式以适应不同布局
        function adjustCardStyles(columns) {
            document.querySelectorAll(`.${CLASS.videoCard}`).forEach(card => {
                card.classList.remove('p-2', 'p-3', 'p-4');
            });
            
            if (columns === 4) {
                DOM.videoGrid.classList.add('gap-4');
            } else if (columns === 1) {
                DOM.videoGrid.classList.add('gap-6');
                document.querySelectorAll(`.${CLASS.videoCard}`).forEach(card => {
                    card.classList.add('p-4');
                    const title = card.querySelector('h3');
                    title.classList.add('text-lg');
                });
            } else {
                DOM.videoGrid.classList.add('gap-6');
                document.querySelectorAll(`.${CLASS.videoCard}`).forEach(card => {
                    card.classList.add('p-3');
                });
            }
        }

        // 生成视频卡片
        function createVideoCards() {
            applyLayout();
            
            const fragment = document.createDocumentFragment();
            allImages = [];
            failedImages = [];
            retryAttempts = 0;
            
            videos.forEach(video => {
                const card = document.createElement('div');
                card.className = `bg-white rounded-xl overflow-hidden shadow-lg ${CLASS.videoCard} transform transition-all`;
                card.dataset.videoId = video.id;
                card.innerHTML = `
                    <div class="relative aspect-video bg-gray-100 overflow-hidden">
                        <!-- 加载指示器 -->
                        <div class="${CLASS.coverLoading} absolute inset-0 flex items-center justify-center">
                            <div class="w-10 h-10 border-4 border-primary/30 border-t-primary rounded-full animate-spin"></div>
                        </div>
                        <!-- 错误提示 -->
                        <div class="${CLASS.errorMessage} border-2 border-error">
                            <i class="fa fa-exclamation-triangle text-error text-2xl mb-1"></i>
                            <p class="text-error text-sm font-medium">封面加载失败</p>
                            <p class="${CLASS.errorReason} text-gray-600 text-xs mt-1"></p>
                        </div>
                        <!-- 封面图 -->
                        <img class="video-cover w-full h-full object-cover opacity-0 transition-opacity duration-500" 
                             data-src="${video.cover}" 
                             src="" 
                             alt="${video.title}">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                            <div class="w-14 h-14 rounded-full bg-primary/90 flex items-center justify-center transform hover:scale-110 transition-transform">
                                <i class="fa fa-play text-white text-xl ml-1"></i>
                            </div>
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="font-medium line-clamp-2 text-gray-800">${video.title}</h3>
                    </div>
                `;
                
                const coverImg = card.querySelector('.video-cover');
                const loadingIndicator = card.querySelector(`.${CLASS.coverLoading}`);
                const errorMessage = card.querySelector(`.${CLASS.errorMessage}`);
                const errorReason = card.querySelector(`.${CLASS.errorReason}`);
                
                allImages.push({
                    img: coverImg,
                    loading: loadingIndicator,
                    error: errorMessage,
                    errorReason: errorReason,
                    src: video.cover,
                    title: video.title,
                    loaded: false,
                    failed: false
                });
                
                fragment.appendChild(card);
            });
            
            DOM.videoGrid.appendChild(fragment);
            
            DOM.totalItems.textContent = allImages.length;
            DOM.globalLoading.classList.remove(CLASS.hidden);
            
            startSequentialLoading();
        }

        // 开始有序加载图片
        function startSequentialLoading() {
            currentLoadIndex = 0;
            loadNextImage();
        }

        // 加载下一张图片
        function loadNextImage() {
            if (currentLoadIndex >= allImages.length) {
                // 所有图片加载完成
                checkAndRetryFailedImages();
                return;
            }
            
            updateLoadingProgress();
            
            const imageInfo = allImages[currentLoadIndex];
            const img = imageInfo.img;
            
            img.removeEventListener('load', onImageLoad);
            img.removeEventListener('error', onImageError);
            
            img.addEventListener('load', () => onImageLoad(imageInfo));
            img.addEventListener('error', (e) => onImageError(e, imageInfo));
            
            img.src = imageInfo.src;
        }

        // 图片加载成功处理
        function onImageLoad(imageInfo) {
            imageInfo.loaded = true;
            imageInfo.failed = false;
            
            // 从失败列表中移除
            const index = failedImages.indexOf(imageInfo);
            if (index > -1) {
                failedImages.splice(index, 1);
            }
            
            imageInfo.img.classList.remove('opacity-0');
            imageInfo.loading.classList.add(CLASS.hidden);
            imageInfo.error.classList.add(CLASS.hidden);
            
            currentLoadIndex++;
            setTimeout(loadNextImage, loadDelay);
        }

        // 图片加载失败处理
        function onImageError(event, imageInfo) {
            console.error(`封面加载失败 (${imageInfo.title}):`, imageInfo.src, event);
            
            imageInfo.loaded = false;
            imageInfo.failed = true;
            
            // 添加到失败列表
            if (!failedImages.includes(imageInfo)) {
                failedImages.push(imageInfo);
            }
            
            imageInfo.loading.classList.add(CLASS.hidden);
            
            let reason = "未知错误";
            if (event.target.error) {
                switch(event.target.error.code) {
                    case event.target.error.NETWORK_ERROR:
                        reason = "网络错误";
                        break;
                    case event.target.error.HTTP_ERROR:
                        reason = "HTTP错误";
                        break;
                    case event.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        reason = "资源不支持";
                        break;
                    default:
                        reason = `错误代码: ${event.target.error.code}`;
                }
            } else {
                reason = "无法加载资源";
            }
            
            imageInfo.errorReason.textContent = `原因: ${reason}`;
            imageInfo.error.classList.remove(CLASS.hidden);
            
            currentLoadIndex++;
            setTimeout(loadNextImage, loadDelay);
        }

        // 检查并自动重试失败的图片
        function checkAndRetryFailedImages() {
            // 更新顶部重试按钮状态
            if (failedImages.length > 0) {
                DOM.topRetryBtn.classList.remove(CLASS.hidden);
            } else {
                DOM.topRetryBtn.classList.add(CLASS.hidden);
            }
            
            // 自动重试逻辑
            if (failedImages.length > 0 && retryAttempts < maxRetryAttempts) {
                retryAttempts++;
                DOM.loadingText.textContent = `正在重新加载失败的封面 (第 ${retryAttempts}/${maxRetryAttempts} 次)`;
                DOM.globalLoading.classList.remove(CLASS.hidden);
                
                // 延迟重试
                setTimeout(() => {
                    retryFailedImages();
                }, retryDelay);
            } else {
                DOM.globalLoading.classList.add(CLASS.hidden);
            }
        }

        // 重新加载失败的图片
        function retryFailedImages() {
            if (failedImages.length === 0) return;
            
            // 重置失败图片的状态
            failedImages.forEach(imgInfo => {
                imgInfo.loading.classList.remove(CLASS.hidden);
                imgInfo.error.classList.add(CLASS.hidden);
                imgInfo.failed = false;
            });
            
            // 保存当前失败列表并重置
            const imagesToRetry = [...failedImages];
            failedImages = [];
            
            // 依次重新加载
            let retryIndex = 0;
            
            function retryNext() {
                if (retryIndex >= imagesToRetry.length) {
                    // 此次重试完成，检查是否需要继续重试
                    loadNextImage();
                    return;
                }
                
                // 更新进度
                const progress = ((retryIndex + 1) / imagesToRetry.length) * 100;
                DOM.loadingBar.style.width = `${progress}%`;
                DOM.loadingProgress.textContent = retryIndex + 1;
                DOM.totalItems.textContent = imagesToRetry.length;
                
                const imgInfo = imagesToRetry[retryIndex];
                const img = imgInfo.img;
                
                img.removeEventListener('load', onRetryLoad);
                img.removeEventListener('error', onRetryError);
                
                img.addEventListener('load', () => onRetryLoad(imgInfo));
                img.addEventListener('error', (e) => onRetryError(e, imgInfo));
                
                // 添加随机参数避免缓存
                const timestamp = new Date().getTime();
                const srcWithCacheBust = imgInfo.src.includes('?') 
                    ? `${imgInfo.src}&t=${timestamp}` 
                    : `${imgInfo.src}?t=${timestamp}`;
                
                img.src = srcWithCacheBust;
                
                function onRetryLoad(info) {
                    info.loaded = true;
                    info.loading.classList.add(CLASS.hidden);
                    img.classList.remove('opacity-0');
                    
                    retryIndex++;
                    setTimeout(retryNext, loadDelay);
                }
                
                function onRetryError(e, info) {
                    info.failed = true;
                    failedImages.push(info);
                    info.loading.classList.add(CLASS.hidden);
                    info.error.classList.remove(CLASS.hidden);
                    
                    retryIndex++;
                    setTimeout(retryNext, loadDelay);
                }
            }
            
            // 开始重新加载
            retryNext();
        }

        // 更新加载进度显示
        function updateLoadingProgress() {
            DOM.loadingProgress.textContent = currentLoadIndex + 1;
            const progressPercent = ((currentLoadIndex + 1) / allImages.length) * 100;
            DOM.loadingBar.style.width = `${progressPercent}%`;
        }

        // 视频播放状态管理
        let playRequested = false;
        
        // 打开视频播放 - 修复版
        function openVideo(video) {
            if (!video || !video.url) {
                console.error("无效的视频信息");
                return;
            }
            
            // 保存当前播放的视频信息
            currentVideo = video;
            playRequested = true;
            
            // 重置视频错误状态
            DOM.videoError.classList.add(CLASS.hidden);
            
            DOM.modalTitle.textContent = video.title;
            setLoading(true);
            DOM.videoPlayer.pause();
            
            // 移除之前的事件监听器，防止重复绑定
            DOM.videoPlayer.removeEventListener('canplay', playWhenReady);
            DOM.videoPlayer.removeEventListener('error', handleVideoError);
            DOM.videoPlayer.removeEventListener('loadedmetadata', onLoadedMetadata);
            
            // 设置视频源并加载
            DOM.videoPlayer.src = video.url;
            DOM.videoPlayer.load();
            
            // 添加事件监听器
            DOM.videoPlayer.addEventListener('canplay', playWhenReady);
            DOM.videoPlayer.addEventListener('error', handleVideoError);
            DOM.videoPlayer.addEventListener('loadedmetadata', onLoadedMetadata);
            
            // 显示模态框
            DOM.videoModal.classList.remove(CLASS.hidden);
            document.body.style.overflow = 'hidden';
        }
        
        // 视频元数据加载完成
        function onLoadedMetadata() {
            console.log("视频元数据加载完成");
            // 可以在这里设置视频的初始音量等
        }
        
        // 当视频可以播放时
        function playWhenReady() {
            if (playRequested) {
                // 尝试播放视频
                DOM.videoPlayer.play()
                    .then(() => {
                        console.log("视频播放成功");
                        setLoading(false);
                    })
                    .catch(error => {
                        console.error('播放失败:', error);
                        handlePlayError(error);
                    });
                DOM.videoPlayer.removeEventListener('canplay', playWhenReady);
            }
        }
        
        // 处理播放错误
        function handlePlayError(error) {
            setLoading(false);
            
            // 显示错误信息
            DOM.videoError.classList.remove(CLASS.hidden);
            
            // 根据错误类型显示不同信息
            let errorMsg = "无法播放视频，请稍后重试";
            if (error.name === 'NotAllowedError') {
                errorMsg = "自动播放被浏览器阻止，请点击播放按钮手动播放";
            } else if (error.name === 'NotFoundError') {
                errorMsg = "视频资源未找到";
            } else if (error.name === 'NetworkError') {
                errorMsg = "网络错误，无法加载视频";
            }
            
            DOM.videoErrorMessage.textContent = errorMsg;
        }
        
        // 处理视频加载错误
        function handleVideoError() {
            console.error('视频加载错误:', DOM.videoPlayer.error);
            setLoading(false);
            
            // 显示错误信息
            DOM.videoError.classList.remove(CLASS.hidden);
            
            let errorMsg = "视频加载失败";
            if (DOM.videoPlayer.error) {
                switch(DOM.videoPlayer.error.code) {
                    case 1: // MEDIA_ERR_ABORTED
                        errorMsg = "视频加载被中止";
                        break;
                    case 2: // MEDIA_ERR_NETWORK
                        errorMsg = "网络错误导致视频加载失败";
                        break;
                    case 3: // MEDIA_ERR_DECODE
                        errorMsg = "视频解码失败";
                        break;
                    case 4: // MEDIA_ERR_SRC_NOT_SUPPORTED
                        errorMsg = "视频格式不受支持";
                        break;
                    default:
                        errorMsg = "未知错误导致视频无法加载";
                }
            }
            
            DOM.videoErrorMessage.textContent = errorMsg;
        }
        
        // 重试播放视频
        function retryPlayingVideo() {
            if (!currentVideo) return;
            
            // 隐藏错误信息
            DOM.videoError.classList.add(CLASS.hidden);
            setLoading(true);
            
            // 重新加载视频
            DOM.videoPlayer.src = currentVideo.url;
            DOM.videoPlayer.load();
            
            // 重新尝试播放
            playRequested = true;
            DOM.videoPlayer.addEventListener('canplay', playWhenReady);
        }
        
        // 设置加载状态
        function setLoading(state) {
            DOM.loadingIndicator.classList.toggle(CLASS.hidden, !state);
        }

        // 关闭视频播放
        function closeVideo() {
            playRequested = false;
            currentVideo = null;
            
            DOM.videoModal.classList.add(CLASS.hidden);
            DOM.videoPlayer.pause();
            document.body.style.overflow = '';
            
            // 清理事件监听器
            DOM.videoPlayer.removeEventListener('canplay', playWhenReady);
            DOM.videoPlayer.removeEventListener('error', handleVideoError);
            DOM.videoPlayer.removeEventListener('loadedmetadata', onLoadedMetadata);
        }

        // 事件监听初始化
        function initEventListeners() {
            // 关闭视频按钮
            DOM.closeModal.addEventListener('click', closeVideo);
            
            // 点击模态框外部关闭
            DOM.videoModal.addEventListener('click', (e) => {
                if (e.target === DOM.videoModal) {
                    closeVideo();
                }
            });
            
            // 键盘ESC关闭
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !DOM.videoModal.classList.contains(CLASS.hidden)) {
                    closeVideo();
                }
            });
            
            // 视频卡片点击
            DOM.videoGrid.addEventListener('click', (e) => {
                const card = e.target.closest(`.${CLASS.videoCard}`);
                if (card) {
                    const videoId = parseInt(card.dataset.videoId);
                    const video = videos.find(v => v.id === videoId);
                    if (video) openVideo(video);
                }
            });
            
            // 窗口大小改变
            window.addEventListener('resize', debounce(applyLayout, 300));
            
            // 顶部重新加载封面按钮
            DOM.topRetryBtn.addEventListener('click', () => {
                DOM.topRetryBtn.classList.add(CLASS.hidden);
                DOM.loadingText.textContent = "正在重新加载失败的封面";
                DOM.globalLoading.classList.remove(CLASS.hidden);
                retryFailedImages();
            });
            
            // 视频播放重试按钮
            DOM.retryVideo.addEventListener('click', retryPlayingVideo);
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // 页面卸载时清理资源
        function cleanupOnUnload() {
            currentLoadIndex = allImages.length;
            DOM.videoPlayer.pause();
            DOM.videoPlayer.src = '';
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            createVideoCards();
            initEventListeners();
        });
        
        window.addEventListener('unload', cleanupOnUnload);
    </script>
</body>
</html>
