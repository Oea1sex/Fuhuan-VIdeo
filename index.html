<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>福皇播放器BETA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#1E40AF',
                        error: '#EF4444',
                        dark: {
                            bg: '#121212',
                            card: '#1E1E1E',
                            text: '#E0E0E0',
                            textLight: '#AAAAAA'
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px) scale(0.95)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' }
                        },
                        fadeOut: {
                            '0%': { opacity: '1', transform: 'translateY(0) scale(1)' },
                            '100%': { opacity: '0', transform: 'translateY(-20px) scale(0.8)' }
                        },
                        slideIn: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideOut: {
                            '0%': { opacity: '1', transform: 'translateY(0)' },
                            '100%': { opacity: '0', transform: 'translateY(-30px)' }
                        },
                        pulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.5' }
                        },
                        touchFeedback: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(0.95)' }
                        },
                        spin: {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' }
                        }
                    },
                    animation: {
                        fadeIn: 'fadeIn 0.4s ease-out forwards',
                        fadeOut: 'fadeOut 0.3s ease-in forwards',
                        slideIn: 'slideIn 0.5s ease-out forwards',
                        slideOut: 'slideOut 0.4s ease-in forwards',
                        pulse: 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        touchFeedback: 'touchFeedback 0.2s ease-in-out forwards',
                        spin: 'spin 1s linear infinite'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .aspect-9x16 {
                aspect-ratio: 9 / 16;
            }
            
            .video-card {
                @apply transition-all duration-300 hover:shadow-xl hover:-translate-y-1 hover:scale-[1.02] will-change-transform cursor-pointer;
            }
            .play-overlay {
                @apply opacity-0 hover:opacity-100 transition-opacity duration-300;
            }
            .cover-loading {
                @apply absolute inset-0 flex items-center justify-center;
            }
            .cover-error {
                @apply absolute inset-0 bg-gray-200 dark:bg-gray-800 flex flex-col items-center justify-center p-4 text-center hidden;
            }
            .grid-2x { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .grid-3x { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .grid-4x { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .grid-1x { grid-template-columns: 1fr; }
            
            .backdrop-blur {
                backdrop-filter: blur(8px);
            }
            .player-container {
                @apply bg-black rounded-xl overflow-hidden mb-8 shadow-xl transition-all duration-300;
            }
            .card-enter {
                @apply opacity-0 transform scale-95;
            }
            .card-enter-active {
                @apply opacity-100 transform scale-100 transition-all duration-500;
            }
            .mobile-player {
                @apply fixed inset-0 z-50 rounded-none mb-0;
            }
            .touch-friendly {
                @apply min-h-[44px] min-w-[44px] flex items-center justify-center;
            }
            .mobile-grid {
                @apply grid-1x gap-4 px-3;
            }
            .mobile-card {
                @apply p-2;
            }
            .custom-pause-button {
                @apply absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white w-16 h-16 rounded-full flex items-center justify-center opacity-0 hover:opacity-100 transition-all duration-300 z-10;
            }
            .custom-pause-button.visible {
                @apply opacity-100;
            }
            .control-button {
                @apply transition-all duration-200 hover:scale-110 focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
            .smooth-transition {
                @apply transition-all duration-300 ease-in-out;
            }
            .exit-screen {
                @apply animate-slideOut pointer-events-none;
            }
            .enter-screen {
                @apply animate-slideIn;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg font-inter text-gray-800 dark:text-dark-text transition-colors duration-500">
    <!-- 顶部导航 -->
    <header class="sticky top-0 z-30 bg-white/90 dark:bg-dark-card/90 backdrop-blur shadow-sm py-3 px-4 transition-all duration-500">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800 dark:text-white smooth-transition">福皇播放器BETA</h1>
            <div class="flex items-center gap-3">
                <button id="theme-toggle" class="control-button p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <i class="fa fa-moon-o text-gray-600 dark:text-gray-300 smooth-transition"></i>
                </button>
                <button id="reload-covers" class="control-button px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                    <i class="fa fa-refresh mr-1"></i> 重新加载封面
                </button>
            </div>
        </div>
    </header>

    <!-- 视频播放器 -->
    <div class="container mx-auto px-4 py-6">
        <div id="video-player-container" class="player-container hidden">
            <!-- 视频头部控制区 -->
            <div class="flex justify-between items-center p-4 bg-gradient-to-b from-black/80 to-transparent text-white">
                <h2 id="video-title" class="text-xl font-semibold truncate max-w-[70%] smooth-transition"></h2>
                <button id="close-player" class="control-button w-10 h-10 rounded-full bg-black/30 backdrop-blur flex items-center justify-center hover:bg-black/50 transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- 视频播放区 -->
            <div class="relative">
                <!-- 自定义暂停按钮 -->
                <button id="custom-pause-button" class="custom-pause-button">
                    <i class="fa fa-pause text-2xl"></i>
                </button>
                
                <!-- 视频播放错误提示 -->
                <div id="video-error" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center text-white hidden opacity-0 transition-opacity duration-300">
                    <i class="fa fa-exclamation-circle text-error text-4xl mb-4 animate-pulse"></i>
                    <p class="text-xl font-medium mb-2">视频播放失败</p>
                    <p id="video-error-message" class="text-gray-300 mb-6 text-center px-4">无法加载视频，请稍后重试</p>
                    <button id="retry-video" class="control-button px-6 py-2 bg-primary hover:bg-secondary rounded-lg transition-colors">
                        <i class="fa fa-refresh mr-1"></i> 重试
                    </button>
                </div>
                
                <video id="video-player" class="w-full object-contain" oncontextmenu="return false;"></video>
                <div id="loading-indicator" class="hidden absolute inset-0 flex items-center justify-center bg-black/30">
                    <i class="fa fa-circle-o-notch text-white text-4xl animate-spin"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 视频列表 -->
    <div class="container mx-auto px-4 py-4">
        <div id="video-grid" class="grid gap-4"></div>
        
        <!-- 全局加载状态指示器 -->
        <div id="global-loading" class="mt-8 text-center hidden animate-fadeIn">
            <p class="text-gray-600 dark:text-gray-400">
                <span id="loading-text">正在加载封面图片</span> 
                <span id="loading-progress">0</span>/<span id="total-items">0</span>
            </p>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-2 overflow-hidden">
                <div id="loading-bar" class="bg-primary h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <script>
        const VideoPlayerApp = {
            elements: {},
            
            config: {
                errorCoverUrl: "https://d.feiliupan.com/t/127891246667534336/ERROR.jpeg",
                baseLoadDelay: 150,      // 基础加载间隔时间(ms)
                variableLoadDelay: 100,   // 随机延迟范围(ms)
                batchSize: 2,             // 每批加载的封面数量
                videoLoadTimeout: 15000,
                scrollDuration: 500,
                touchAnimationDuration: 200,
                visibleThreshold: 0.5     // 元素可见比例阈值
            },
            
            state: {
                videos: [
                    { id: 1, title: "空悲切", url: "https://d.feiliupan.com/t/127891246667534336/konbeiqie.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/konbeiqie.jpg" },
                    { id: 2, title: "旧时的福家拳", url: "https://d.feiliupan.com/t/127891246667534336/Fujiaquan.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/fujiaquan.jpg" },
                    { id: 3, title: "神经班", url: "https://d.feiliupan.com/t/127891246667534336/sjban.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/sjban.jpg" },
                    { id: 4, title: "妖娆", url: "https://d.feiliupan.com/t/127891246667534336/yaorao.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/yaorao.jpg" },
                    { id: 5, title: "缘分本就稀薄寡淡", url: "https://d.feiliupan.com/t/127891246667534336/yuanfen.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/yuanfen.jpg" },
                    { id: 6, title: "全场最佳", url: "https://d.feiliupan.com/t/127891246667534336/quanchangzuijia.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/quanchangzuijia.jpg" },
                    { id: 7, title: "期待本就是很无力的东西", url: "https://d.feiliupan.com/t/127891246667534336/qiedaiwuli.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/qiedaiwuli.jpg" },
                    { id: 8, title: "他还在", url: "https://d.feiliupan.com/t/127891246667534336/tahaizai.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/tahaizai.jpg" },
                    { id: 9, title: "最特别的老师", url: "https://d.feiliupan.com/t/127891246667534336/tebiedeDog.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/tebiedeDog.jpg" },
                    { id: 10, title: "他还是来了", url: "https://d.feiliupan.com/t/127891246667534336/tahaisilaile.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/tahaisilaile.jpg" },
                    { id: 11, title: "肚子越大的人跑步越快", url: "https://d.feiliupan.com/t/127891246667534336/dudapaokuai.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/dudapaokuai.jpg" },
                    { id: 12, title: "权威", url: "https://d.feiliupan.com/t/127891246667534336/quanwei.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/quanwei.jpg" },
                    { id: 13, title: "福拳", url: "https://d.feiliupan.com/t/127891246667534336/fuquan.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/fuquan.jpg" },
                    { id: 14, title: "我们都太年轻了", url: "https://d.feiliupan.com/t/127891246667534336/womendoutainianqinle.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/womendoutainianqinle.jpg" },
                    { id: 15, title: "福哥对不起", url: "https://d.feiliupan.com/t/127891246667534336/fuge520.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/fuge520.jpg" },
                    { id: 16, title: "戒了烟我不习惯", url: "https://d.feiliupan.com/t/127891246667534336/jieyan.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/jieyan.jpg" }
                ],
                currentVideo: null,
                allImages: [],
                failedImages: [],
                currentLoadIndex: 0,
                totalProcessed: 0,
                loadTimeout: null,
                isMobile: false,
                isScrolling: false,
                loadIntervalId: null,
                lastScrollTop: 0,
                scrollDirection: '',
                observer: null
            },
            
            init() {
                this.cacheElements();
                this.setupEventListeners();
                this.createVideoCards();
                this.initializeTheme();
                this.checkMobileDevice();
                window.addEventListener('orientationchange', () => this.handleOrientationChange());
            },
            
            cacheElements() {
                this.elements = {
                    videoGrid: document.getElementById('video-grid'),
                    videoContainer: document.getElementById('video-player-container'),
                    videoPlayer: document.getElementById('video-player'),
                    videoTitle: document.getElementById('video-title'),
                    closePlayer: document.getElementById('close-player'),
                    loadingIndicator: document.getElementById('loading-indicator'),
                    globalLoading: document.getElementById('global-loading'),
                    loadingProgress: document.getElementById('loading-progress'),
                    totalItems: document.getElementById('total-items'),
                    loadingBar: document.getElementById('loading-bar'),
                    loadingText: document.getElementById('loading-text'),
                    reloadCovers: document.getElementById('reload-covers'),
                    videoError: document.getElementById('video-error'),
                    videoErrorMessage: document.getElementById('video-error-message'),
                    retryVideo: document.getElementById('retry-video'),
                    themeToggle: document.getElementById('theme-toggle'),
                    themeIcon: document.querySelector('#theme-toggle i'),
                    pauseButton: document.getElementById('custom-pause-button')
                };
            },
            
            checkMobileDevice() {
                this.state.isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (this.state.isMobile) {
                    document.body.classList.add('mobile');
                    this.elements.themeToggle.classList.add('touch-friendly');
                    this.elements.reloadCovers.classList.add('touch-friendly');
                    this.setupScrollAnimationObserver();
                    this.setupLazyLoading();
                }
            },
            
            handleOrientationChange() {
                this.applyLayout();
                if (this.state.currentVideo) {
                    this.elements.videoPlayer.style.height = 'auto';
                    setTimeout(() => {
                        this.elements.videoPlayer.style.height = `${this.elements.videoPlayer.offsetWidth * 16 / 9}px`;
                    }, 100);
                }
            },
            
            setupEventListeners() {
                // 视频卡片点击事件
                this.elements.videoGrid.addEventListener('click', (e) => {
                    const card = e.target.closest('.video-card');
                    if (card) {
                        this.addTouchFeedback(card);
                        const videoId = parseInt(card.dataset.videoId);
                        setTimeout(() => this.playVideo(videoId), this.config.touchAnimationDuration);
                    }
                });
                
                // 关闭播放器
                this.elements.closePlayer.addEventListener('click', () => this.closeVideoPlayer());
                
                // 视频事件监听
                ['error', 'canplay', 'loadeddata', 'play', 'waiting', 'pause', 'ended'].forEach(event => {
                    this.elements.videoPlayer.addEventListener(event, (e) => this.handleVideoEvent(event, e));
                });
                
                // 重试播放视频
                this.elements.retryVideo.addEventListener('click', () => this.retryVideoPlayback());
                
                // 重新加载封面按钮
                this.elements.reloadCovers.addEventListener('click', () => this.reloadAllCovers());
                
                // 窗口大小变化时重新布局
                window.addEventListener('resize', () => this.applyLayout());
                
                // 主题切换
                this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());
                
                // 自定义暂停/播放按钮点击事件
                this.elements.pauseButton.addEventListener('click', () => this.togglePlayPause());
                
                // 点击视频区域触发暂停/播放
                this.elements.videoPlayer.addEventListener('click', () => {
                    this.addTouchFeedback(this.elements.videoPlayer);
                    setTimeout(() => this.togglePlayPause(), this.config.touchAnimationDuration);
                });
                
                // 视频悬停显示暂停按钮
                this.elements.videoContainer.addEventListener('mouseenter', () => {
                    this.elements.pauseButton.classList.add('visible');
                });
                
                this.elements.videoContainer.addEventListener('mouseleave', () => {
                    if (!this.elements.videoPlayer.paused) {
                        this.elements.pauseButton.classList.remove('visible');
                    }
                });
                
                // 设置按钮触摸反馈
                this.setupButtonTouchHandling();
                
                // 滚动方向检测
                window.addEventListener('scroll', () => this.detectScrollDirection());
            },
            
            // 检测滚动方向
            detectScrollDirection() {
                const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                if (currentScrollTop > this.state.lastScrollTop && currentScrollTop > 100) {
                    // 向下滚动
                    this.state.scrollDirection = 'down';
                } else if (currentScrollTop < this.state.lastScrollTop) {
                    // 向上滚动
                    this.state.scrollDirection = 'up';
                }
                
                this.state.lastScrollTop = currentScrollTop <= 0 ? 0 : currentScrollTop;
            },
            
            // 设置滚动动画观察器
            setupScrollAnimationObserver() {
                if ('IntersectionObserver' in window && this.state.isMobile) {
                    this.state.observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            const card = entry.target;
                            
                            // 清除所有动画类
                            card.classList.remove('enter-screen', 'exit-screen');
                            
                            if (entry.isIntersecting) {
                                // 元素进入视口
                                card.classList.add('enter-screen');
                            } else {
                                // 元素离开视口，根据滚动方向添加不同动画
                                if (this.state.scrollDirection === 'down' && entry.boundingClientRect.top < 0) {
                                    // 向上隐藏（缩小并上移）
                                    card.classList.add('exit-screen');
                                }
                            }
                        });
                    }, { 
                        rootMargin: '0px 0px -50% 0px',
                        threshold: this.config.visibleThreshold
                    });
                }
            },
            
            handleVideoEvent(event, e) {
                switch(event) {
                    case 'error':
                        this.handleVideoError(e);
                        break;
                    case 'canplay':
                    case 'loadeddata':
                    case 'pause':
                    case 'ended':
                        this.hideLoadingIndicator();
                        this.updatePauseButtonIcon();
                        break;
                    case 'play':
                        this.hideLoadingIndicator();
                        this.updatePauseButtonIcon();
                        break;
                    case 'waiting':
                        if (this.elements.videoError.classList.contains('hidden')) {
                            this.showLoadingIndicator();
                        }
                        break;
                }
            },
            
            setupButtonTouchHandling() {
                document.querySelectorAll('button').forEach(button => {
                    // 触摸事件
                    ['touchstart', 'mousedown'].forEach(event => {
                        button.addEventListener(event, (e) => {
                            if (event === 'touchstart') e.preventDefault();
                            this.addTouchFeedback(button);
                        });
                    });
                    
                    ['touchend', 'touchcancel', 'mouseup', 'mouseleave'].forEach(event => {
                        button.addEventListener(event, (e) => {
                            if (['touchend', 'touchcancel'].includes(event)) e.preventDefault();
                            this.clearTouchFeedback(button);
                        });
                    });
                });
            },
            
            addTouchFeedback(element) {
                if (this.state.isMobile) {
                    element.classList.add('animate-touchFeedback');
                }
            },
            
            clearTouchFeedback(element) {
                if (this.state.isMobile) {
                    setTimeout(() => {
                        element.classList.remove('animate-touchFeedback');
                    }, this.config.touchAnimationDuration);
                }
            },
            
            togglePlayPause() {
                if (this.elements.videoPlayer.paused || this.elements.videoPlayer.ended) {
                    this.elements.videoPlayer.play();
                } else {
                    this.elements.videoPlayer.pause();
                }
            },
            
            updatePauseButtonIcon() {
                const icon = this.elements.pauseButton.querySelector('i');
                if (this.elements.videoPlayer.paused || this.elements.videoPlayer.ended) {
                    icon.classList.replace('fa-pause', 'fa-play');
                    this.elements.pauseButton.classList.add('visible');
                } else {
                    icon.classList.replace('fa-play', 'fa-pause');
                    if (!this.isMouseOverVideo()) {
                        this.elements.pauseButton.classList.remove('visible');
                    }
                }
            },
            
            isMouseOverVideo() {
                return this.elements.pauseButton.classList.contains('visible');
            },
            
            scrollToTop() {
                if (this.state.isScrolling) return;
                
                this.state.isScrolling = true;
                const startPosition = window.scrollY;
                const distance = -startPosition;
                const duration = this.config.scrollDuration;
                let startTime = null;
                
                const animation = (currentTime) => {
                    if (startTime === null) startTime = currentTime;
                    const timeElapsed = currentTime - startTime;
                    const run = this.easeInOutQuad(timeElapsed, startPosition, distance, duration);
                    window.scrollTo(0, run);
                    
                    if (timeElapsed < duration) {
                        requestAnimationFrame(animation);
                    } else {
                        this.state.isScrolling = false;
                    }
                };
                
                requestAnimationFrame(animation);
            },
            
            easeInOutQuad(t, b, c, d) {
                t /= d / 2;
                return t < 1 ? c / 2 * t * t + b : -c / 2 * (--t * (t - 2) - 1) + b;
            },
            
            // 增强版懒加载实现
            setupLazyLoading() {
                if ('IntersectionObserver' in window && this.state.isMobile) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                const src = img.dataset.src;
                                if (src) {
                                    // 添加加载指示器
                                    const loadingIndicator = img.parentElement.querySelector('.cover-loading');
                                    loadingIndicator.classList.remove('hidden');
                                    
                                    // 图片加载完成后隐藏指示器
                                    img.onload = () => {
                                        loadingIndicator.classList.add('hidden');
                                        img.classList.remove('opacity-0');
                                    };
                                    
                                    img.onerror = () => {
                                        loadingIndicator.classList.add('hidden');
                                        img.src = this.config.errorCoverUrl;
                                        img.parentElement.querySelector('.cover-error').classList.remove('hidden');
                                    };
                                    
                                    img.src = src;
                                    img.removeAttribute('data-src');
                                }
                                observer.unobserve(img);
                            }
                        });
                    }, { 
                        rootMargin: '500px 0px',  // 提前500px开始加载
                        threshold: 0.01 
                    });

                    document.querySelectorAll('.video-cover[data-src]').forEach(img => observer.observe(img));
                }
            },
            
            showLoadingIndicator() {
                this.elements.loadingIndicator.classList.remove('hidden');
            },
            
            hideLoadingIndicator() {
                this.elements.loadingIndicator.classList.add('hidden');
                
                if (this.state.loadTimeout) {
                    clearTimeout(this.state.loadTimeout);
                    this.state.loadTimeout = null;
                }
            },
            
            determineLayout() {
                const windowWidth = window.innerWidth;
                if (this.state.isMobile) return { columns: 1, name: "1x" };
                if (windowWidth >= 1200) return { columns: 4, name: "4x" };
                if (windowWidth >= 768) return { columns: 3, name: "3x" };
                return { columns: 2, name: "2x" };
            },
            
            applyLayout() {
                const layout = this.determineLayout();
                const grid = this.elements.videoGrid;
                
                // 移除所有布局类
                grid.classList.remove('grid-1x', 'grid-2x', 'grid-3x', 'grid-4x', 'mobile-grid');
                
                // 移动端使用1列网格布局（1x16）
                if (this.state.isMobile) {
                    grid.classList.add('mobile-grid');
                    this.adjustMobileCardStyles();
                    return;
                }
                
                // 桌面端布局
                grid.classList.add(`grid-${layout.name}`);
                this.adjustCardStyles(layout.columns);
            },
            
            adjustMobileCardStyles() {
                document.querySelectorAll('.video-card').forEach(card => {
                    card.classList.remove('p-2', 'p-3', 'p-4');
                    card.classList.add('mobile-card');
                    
                    const title = card.querySelector('h3');
                    title?.classList.remove('text-lg');
                    title?.classList.add('text-base', 'font-semibold');
                });
            },
            
            adjustCardStyles(columns) {
                const cards = document.querySelectorAll('.video-card');
                const grid = this.elements.videoGrid;
                
                // 重置样式
                cards.forEach(card => {
                    card.classList.remove('p-2', 'p-3', 'p-4');
                    const title = card.querySelector('h3');
                    title?.classList.remove('text-lg', 'text-sm', 'text-base', 'font-semibold');
                });
                
                // 设置网格间距
                grid.classList.remove('gap-4', 'gap-5', 'gap-6');
                
                if (columns === 4) {
                    grid.classList.add('gap-4');
                    cards.forEach(card => card.classList.add('p-2'));
                } else if (columns === 3) {
                    grid.classList.add('gap-5');
                    cards.forEach(card => card.classList.add('p-3'));
                } else {
                    grid.classList.add('gap-6');
                    cards.forEach(card => {
                        card.classList.add('p-4');
                        card.querySelector('h3')?.classList.add('text-lg');
                    });
                }
            },
            
            createVideoCards() {
                // 清除可能存在的加载计时器
                if (this.state.loadIntervalId) {
                    clearInterval(this.state.loadIntervalId);
                    this.state.loadIntervalId = null;
                }
                
                // 断开之前的观察器连接
                if (this.state.observer) {
                    document.querySelectorAll('.video-card').forEach(card => {
                        this.state.observer.unobserve(card);
                    });
                }
                
                this.applyLayout();
                
                // 重置状态
                this.state.allImages = [];
                this.state.failedImages = [];
                this.state.currentLoadIndex = 0;
                this.state.totalProcessed = 0;
                
                // 清空网格
                this.elements.videoGrid.innerHTML = '';
                
                const fragment = document.createDocumentFragment();
                
                // 创建所有视频卡片
                this.state.videos.forEach(video => {
                    const card = this.createVideoCard(video);
                    this.state.allImages.push(this.createImageInfo(card, video));
                    fragment.appendChild(card);
                });
                
                this.elements.videoGrid.appendChild(fragment);
                
                // 为移动设备设置滚动动画观察器
                if (this.state.isMobile && this.state.observer) {
                    document.querySelectorAll('.video-card').forEach(card => {
                        this.state.observer.observe(card);
                    });
                }
                
                // 更新加载状态显示
                this.elements.totalItems.textContent = this.state.allImages.length;
                this.elements.globalLoading.classList.remove('hidden');
                
                // 开始分批、间隔加载封面
                if (!this.state.isMobile) {
                    this.startBatchLoading();
                } else {
                    // 移动设备使用懒加载，直接隐藏全局加载
                    setTimeout(() => {
                        this.elements.globalLoading.classList.add('hidden');
                    }, 500);
                }
            },
            
            createVideoCard(video) {
                const card = document.createElement('div');
                card.className = `bg-white dark:bg-dark-card rounded-xl overflow-hidden shadow-lg video-card transform transition-all hidden card-enter`;
                card.dataset.videoId = video.id;
                
                // 视频封面容器
                const coverContainer = document.createElement('div');
                coverContainer.className = 'relative overflow-hidden rounded-lg';
                
                // 视频封面图
                const coverImg = document.createElement('img');
                coverImg.className = 'w-full aspect-9x16 object-cover rounded-lg video-cover opacity-0 transition-opacity duration-500';
                if (this.state.isMobile) {
                    coverImg.dataset.src = video.cover; // 移动端懒加载
                }
                coverImg.alt = video.title;
                
                // 加载指示器 - 添加旋转动画
                const coverLoading = document.createElement('div');
                coverLoading.className = 'cover-loading hidden';
                coverLoading.innerHTML = '<i class="fa fa-circle-o-notch text-gray-400 dark:text-gray-600 text-xl animate-spin"></i>';
                
                // 错误提示
                const coverError = document.createElement('div');
                coverError.className = 'cover-error';
                coverError.innerHTML = `
                    <i class="fa fa-image text-2xl text-gray-500 mb-2"></i>
                    <p class="text-sm text-gray-600 dark:text-gray-400">封面加载失败</p>
                `;
                
                // 播放按钮覆盖层
                const playOverlay = document.createElement('div');
                playOverlay.className = 'play-overlay absolute inset-0 bg-black/40 flex items-center justify-center';
                playOverlay.innerHTML = '<i class="fa fa-play-circle text-white text-3xl transition-transform duration-300 hover:scale-110"></i>';
                
                // 标题
                const title = document.createElement('h3');
                title.className = 'mt-2 font-medium truncate px-1 smooth-transition';
                title.textContent = video.title;
                
                // 组装卡片
                coverContainer.append(coverImg, coverLoading, coverError, playOverlay);
                card.append(coverContainer, title);
                
                return card;
            },
            
            createImageInfo(card, video) {
                return {
                    card,
                    video,
                    img: card.querySelector('img'),
                    loading: card.querySelector('.cover-loading'),
                    error: card.querySelector('.cover-error'),
                    // 图片加载成功处理
                    onLoad: function() {
                        this.loading.classList.add('hidden');
                        this.error.classList.add('hidden');
                        this.img.classList.remove('opacity-0');
                        this.card.classList.remove('hidden');
                        setTimeout(() => this.card.classList.add('card-enter-active'), 50);
                    },
                    // 图片加载失败处理
                    onError: function() {
                        this.loading.classList.add('hidden');
                        this.error.classList.remove('hidden');
                        this.img.src = VideoPlayerApp.config.errorCoverUrl;
                        this.card.classList.remove('hidden');
                        setTimeout(() => this.card.classList.add('card-enter-active'), 50);
                    }
                };
            },
            
            setupScrollAnimation() {
                if ('IntersectionObserver' in window && !this.state.isMobile) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                entry.target.classList.add('card-enter-active');
                                observer.unobserve(entry.target);
                            }
                        });
                    }, { threshold: 0.1 });

                    document.querySelectorAll('.video-card').forEach(card => {
                        observer.observe(card);
                    });
                }
            },
            
            // 批量、间隔加载封面图片
            startBatchLoading() {
                // 计算当前批次的图片
                const batchImages = this.state.allImages.slice(
                    this.state.currentLoadIndex, 
                    this.state.currentLoadIndex + this.config.batchSize
                );
                
                // 加载当前批次的图片
                batchImages.forEach(imgInfo => {
                    if (!imgInfo.img.src && imgInfo.video.cover) {
                        imgInfo.loading.classList.remove('hidden');
                        imgInfo.img.onload = () => this.handleImageLoad(imgInfo);
                        imgInfo.img.onerror = () => this.handleImageError(imgInfo);
                        imgInfo.img.src = imgInfo.video.cover;
                    }
                });
                
                // 更新当前加载索引
                this.state.currentLoadIndex += this.config.batchSize;
                
                // 如果还有图片需要加载，设置下一批的加载计时器
                if (this.state.currentLoadIndex < this.state.allImages.length) {
                    // 计算随机延迟，避免加载过于规律
                    const randomDelay = Math.floor(Math.random() * this.config.variableLoadDelay);
                    const totalDelay = this.config.baseLoadDelay + randomDelay;
                    
                    this.state.loadIntervalId = setTimeout(
                        () => this.startBatchLoading(), 
                        totalDelay
                    );
                }
            },
            
            handleImageLoad(imgInfo) {
                imgInfo.onLoad();
                this.updateLoadingProgress(true);
            },
            
            handleImageError(imgInfo) {
                imgInfo.onError();
                this.state.failedImages.push(imgInfo);
                this.updateLoadingProgress(false);
            },
            
            updateLoadingProgress(success) {
                this.state.totalProcessed++;
                
                // 更新进度显示
                this.elements.loadingProgress.textContent = this.state.totalProcessed;
                const progress = (this.state.totalProcessed / this.state.allImages.length) * 100;
                this.elements.loadingBar.style.width = `${progress}%`;
                
                // 全部加载完成
                if (this.state.totalProcessed === this.state.allImages.length) {
                    setTimeout(() => {
                        this.elements.globalLoading.classList.add('hidden');
                    }, 500);
                }
            },
            
            reloadAllCovers() {
                this.addTouchFeedback(this.elements.reloadCovers);
                this.createVideoCards();
            },
            
            playVideo(videoId) {
                const video = this.state.videos.find(v => v.id === videoId);
                if (!video) return;
                
                this.state.currentVideo = video;
                this.elements.videoTitle.textContent = video.title;
                this.elements.videoPlayer.src = video.url;
                
                // 显示播放器
                this.elements.videoContainer.classList.remove('hidden');
                this.scrollToTop();
                
                // 适配移动设备全屏样式
                if (this.state.isMobile) {
                    this.elements.videoContainer.classList.add('mobile-player');
                    this.elements.videoTitle.classList.add('text-base');
                } else {
                    this.elements.videoContainer.classList.remove('mobile-player');
                    this.elements.videoTitle.classList.remove('text-base');
                }
                
                // 设置视频尺寸为9:16
                this.elements.videoPlayer.style.height = `${this.elements.videoPlayer.offsetWidth * 16 / 9}px`;
                
                // 尝试播放视频
                this.elements.videoPlayer.load();
                this.showLoadingIndicator();
                
                // 设置加载超时
                this.state.loadTimeout = setTimeout(() => {
                    if (this.elements.videoPlayer.paused) {
                        this.handleVideoError({ type: 'timeout' });
                    }
                }, this.config.videoLoadTimeout);
                
                // 尝试播放
                this.elements.videoPlayer.play().catch(err => {
                    this.handleVideoError(err);
                });
            },
            
            closeVideoPlayer() {
                this.elements.videoPlayer.pause();
                this.elements.videoPlayer.src = '';
                this.elements.videoContainer.classList.add('hidden');
                this.state.currentVideo = null;
                this.elements.videoError.classList.add('hidden');
            },
            
            handleVideoError(error) {
                this.hideLoadingIndicator();
                this.elements.videoError.classList.remove('hidden');
                this.elements.videoError.style.opacity = 1;
                
                // 设置错误消息
                let message = '无法加载视频，请稍后重试';
                if (error.type === 'timeout') {
                    message = '视频加载超时，请检查网络连接';
                } else if (error.code === 4) {
                    message = '视频格式不受支持';
                }
                this.elements.videoErrorMessage.textContent = message;
            },
            
            retryVideoPlayback() {
                if (!this.state.currentVideo) return;
                
                this.elements.videoError.style.opacity = 0;
                setTimeout(() => {
                    this.elements.videoError.classList.add('hidden');
                    this.elements.videoPlayer.src = this.state.currentVideo.url;
                    this.elements.videoPlayer.load();
                    this.showLoadingIndicator();
                    
                    this.elements.videoPlayer.play().catch(err => {
                        this.handleVideoError(err);
                    });
                }, 300);
            },
            
            initializeTheme() {
                // 检查用户偏好
                if (localStorage.theme === 'dark' || 
                    (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    this.elements.themeIcon.classList.replace('fa-moon-o', 'fa-sun-o');
                } else {
                    document.documentElement.classList.remove('dark');
                    this.elements.themeIcon.classList.replace('fa-sun-o', 'fa-moon-o');
                }
            },
            
            toggleTheme() {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                    this.elements.themeIcon.classList.replace('fa-sun-o', 'fa-moon-o');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                    this.elements.themeIcon.classList.replace('fa-moon-o', 'fa-sun-o');
                }
            }
        };

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            VideoPlayerApp.init();
        });
    </script>
</body>
</html>
    