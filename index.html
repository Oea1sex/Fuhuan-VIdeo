<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>超级福皇SuperFuhuan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class', // 启用类模式的深色模式
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#1E40AF',
                        error: '#EF4444',
                        dark: {
                            bg: '#121212',
                            card: '#1E1E1E',
                            text: '#E0E0E0',
                            textLight: '#AAAAAA'
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        fadeOut: {
                            '0%': { opacity: '1', transform: 'translateY(0)' },
                            '100%': { opacity: '0', transform: 'translateY(-10px)' }
                        },
                        pulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.5' }
                        }
                    },
                    animation: {
                        fadeIn: 'fadeIn 0.5s ease-out forwards',
                        fadeOut: 'fadeOut 0.3s ease-in forwards',
                        pulse: 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .video-card-hover {
                @apply transition-all duration-300 hover:shadow-xl hover:-translate-y-1 hover:scale-[1.02] will-change-transform cursor-pointer;
            }
            .play-overlay {
                @apply opacity-0 hover:opacity-100 transition-opacity duration-300;
            }
            .error-message {
                @apply absolute inset-0 bg-gray-100 dark:bg-dark-bg flex flex-col items-center justify-center p-2 text-center hidden;
            }
            .cover-loading {
                @apply absolute inset-0 flex items-center justify-center;
            }
            .cover-error {
                @apply absolute inset-0 bg-gray-200 dark:bg-gray-800 flex flex-col items-center justify-center p-4 text-center hidden;
            }
            .grid-4x4 {
                @apply grid-cols-4;
            }
            .grid-1x16 {
                @apply grid-cols-1 gap-3;
            }
            /* 横屏时的手机布局优化 */
            @media (orientation: landscape) and (max-width: 768px) {
                .grid-1x16 {
                    @apply gap-2;
                }
                .mobile-card {
                    @apply p-1;
                }
            }
            /* 竖屏时的手机布局优化 */
            @media (orientation: portrait) and (max-width: 768px) {
                .grid-1x16 {
                    @apply gap-3;
                }
                .mobile-card {
                    @apply p-2;
                }
            }
            .backdrop-blur {
                backdrop-filter: blur(8px);
            }
            .player-container {
                @apply bg-black rounded-xl overflow-hidden mb-8 shadow-xl transition-all duration-300;
            }
            .card-enter {
                @apply opacity-0 transform scale-95;
            }
            .card-enter-active {
                @apply opacity-100 transform scale-100 transition-all duration-500;
            }
            /* 手机专用样式 */
            .mobile-player {
                @apply fixed inset-0 z-50 rounded-none mb-0;
            }
            .mobile-header {
                @apply py-2 px-3;
            }
            .mobile-video-title {
                @apply text-base;
            }
            .touch-friendly {
                @apply min-h-[44px] min-w-[44px] flex items-center justify-center;
            }
            .mobile-card {
                @apply p-1;
            }
            .mobile-play-icon {
                @apply w-12 h-12;
            }
            /* 自定义暂停按钮 */
            .custom-pause-button {
                @apply absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white w-16 h-16 rounded-full flex items-center justify-center opacity-0 hover:opacity-100 transition-all duration-300 z-10;
            }
            .custom-pause-button.visible {
                @apply opacity-100;
            }
            .video-container-hover {
                @apply hover:cursor-pointer;
            }
            /* 动画类 */
            .fade-in {
                @apply opacity-0 animate-fadeIn;
            }
            .fade-out {
                @apply opacity-100 animate-fadeOut;
            }
            /* 控制按钮动画 */
            .control-button {
                @apply transition-all duration-200 hover:scale-110 focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
            /* 平滑过渡 */
            .smooth-transition {
                @apply transition-all duration-300 ease-in-out;
            }
            /* 9:16 比例的视频卡片 */
            .aspect-9-16 {
                aspect-ratio: 9/16;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg font-inter text-gray-800 dark:text-dark-text transition-colors duration-500">
    <!-- 顶部导航 -->
    <header class="sticky top-0 z-30 bg-white/90 dark:bg-dark-card/90 backdrop-blur shadow-sm py-3 px-4 transition-all duration-500">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800 dark:text-white smooth-transition">SuperFuhuan</h1>
            <div class="flex items-center gap-3">
                <button id="theme-toggle" class="control-button p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <i class="fa fa-moon-o text-gray-600 dark:text-gray-300 smooth-transition"></i>
                </button>
                <button id="reload-covers" class="control-button px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                    <i class="fa fa-refresh mr-1"></i> 刷新
                </button>
            </div>
        </div>
    </header>

    <!-- 视频播放器 -->
    <div class="container mx-auto px-4 py-6">
        <div id="video-player-container" class="player-container hidden">
            <!-- 视频头部控制区 -->
            <div class="flex justify-between items-center p-4 bg-gradient-to-b from-black/80 to-transparent text-white">
                <h2 id="video-title" class="text-xl font-semibold truncate max-w-[70%] smooth-transition"></h2>
                <button id="close-player" class="control-button w-10 h-10 rounded-full bg-black/30 backdrop-blur flex items-center justify-center hover:bg-black/50 transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- 视频播放区 -->
            <div class="relative video-container-hover">
                <!-- 自定义暂停按钮 -->
                <button id="custom-pause-button" class="custom-pause-button">
                    <i class="fa fa-pause text-2xl"></i>
                </button>
                
                <!-- 视频播放错误提示 -->
                <div id="video-error" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center text-white hidden opacity-0 transition-opacity duration-300">
                    <i class="fa fa-exclamation-circle text-error text-4xl mb-4 animate-pulse"></i>
                    <p class="text-xl font-medium mb-2">视频播放失败</p>
                    <p id="video-error-message" class="text-gray-300 mb-6 text-center px-4">无法加载视频，请稍后重试</p>
                    <button id="retry-video" class="control-button px-6 py-2 bg-primary hover:bg-secondary rounded-lg transition-colors">
                        <i class="fa fa-refresh mr-1"></i> 重试
                    </button>
                </div>
                
                <video id="video-player" class="w-full aspect-video object-contain" oncontextmenu="return false;"></video>
                <!-- 移除了视频播放加载指示器 -->
                <div id="loading-indicator" class="hidden absolute inset-0 flex items-center justify-center bg-black/30"></div>
            </div>
        </div>
    </div>

    <!-- 视频列表 -->
    <div class="container mx-auto px-4 py-4">
        <div id="video-grid" class="grid gap-4"></div>
        
        <!-- 全局加载状态指示器 -->
        <div id="global-loading" class="mt-8 text-center hidden fade-in">
            <p class="text-gray-600 dark:text-gray-400">
                <span id="loading-text">正在加载封面图片</span> 
                <span id="loading-progress">0</span>/<span id="total-items">0</span>
            </p>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-2 overflow-hidden">
                <div id="loading-bar" class="bg-primary h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <script>
        // 应用主控制器
        const VideoPlayerApp = {
            // DOM元素缓存
            elements: {
                videoGrid: document.getElementById('video-grid'),
                videoContainer: document.getElementById('video-player-container'),
                videoPlayer: document.getElementById('video-player'),
                videoTitle: document.getElementById('video-title'),
                closePlayer: document.getElementById('close-player'),
                loadingIndicator: document.getElementById('loading-indicator'),
                globalLoading: document.getElementById('global-loading'),
                loadingProgress: document.getElementById('loading-progress'),
                totalItems: document.getElementById('total-items'),
                loadingBar: document.getElementById('loading-bar'),
                loadingText: document.getElementById('loading-text'),
                reloadCovers: document.getElementById('reload-covers'),
                videoError: document.getElementById('video-error'),
                videoErrorMessage: document.getElementById('video-error-message'),
                retryVideo: document.getElementById('retry-video'),
                themeToggle: document.getElementById('theme-toggle'),
                themeIcon: document.querySelector('#theme-toggle i'),
                // 自定义暂停按钮
                pauseButton: document.getElementById('custom-pause-button'),
                // 页面顶部元素引用
                header: document.querySelector('header')
            },
            
            // 样式类名常量
            classes: {
                hidden: 'hidden',
                videoCard: 'video-card-hover',
                coverLoading: 'cover-loading',
                coverError: 'cover-error',
                grid4x4: 'grid-4x4',
                grid1x16: 'grid-1x16',
                grid2x8: 'grid-2x8',
                cardEnter: 'card-enter',
                cardEnterActive: 'card-enter-active',
                active: 'active',
                visible: 'visible',
                fadeIn: 'fade-in',
                fadeOut: 'fade-out'
            },
            
            // 配置常量
            config: {
                errorCoverUrl: "https://d.feiliupan.com/t/127891246667534336/ERROR.jpeg",
                loadDelay: 300,
                videoLoadTimeout: 15000, // 视频加载超时时间(毫秒)
                scrollDuration: 500 // 滚动动画持续时间(毫秒)
            },
            
            // 应用状态
            state: {
                videos: [
                    { id: 1, title: "空悲切", url: "https://d.feiliupan.com/t/127891246667534336/konbeiqie.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/konbeiqie.jpg" },
                    { id: 2, title: "旧时的福家拳", url: "https://d.feiliupan.com/t/127891246667534336/Fujiaquan.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/fujiaquan.jpg" },
                    { id: 3, title: "神经班", url: "https://d.feiliupan.com/t/127891246667534336/sjban.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/sjban.jpg" },
                    { id: 4, title: "妖娆", url: "https://d.feiliupan.com/t/127891246667534336/yaorao.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/yaorao.jpg" },
                    { id: 5, title: "缘分本就稀薄寡淡 多是清尘浊水后会无期", url: "https://d.feiliupan.com/t/127891246667534336/yuanfen.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/yuanfen.jpg" },
                    { id: 6, title: "全场最佳", url: "https://d.feiliupan.com/t/127891246667534336/quanchangzuijia.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/quanchangzuijia.jpg" },
                    { id: 7, title: "期待本就是很无力的东西", url: "https://d.feiliupan.com/t/127891246667534336/qiedaiwuli.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/qiedaiwuli.jpg" },
                    { id: 8, title: "他还在", url: "https://d.feiliupan.com/t/127891246667534336/tahaizai.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/tahaizai.jpg" },
                    { id: 9, title: "最特别的老师", url: "https://d.feiliupan.com/t/127891246667534336/tebiedeDog.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/tebiedeDog.jpg" },
                    { id: 10, title: "他还是来了", url: "https://d.feiliupan.com/t/127891246667534336/tahaisilaile.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/tahaisilaile.jpg" },
                    { id: 11, title: "肚子越大的人跑步越快", url: "https://d.feiliupan.com/t/127891246667534336/dudapaokuai.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/dudapaokuai.jpg" },
                    { id: 12, title: "权威", url: "https://d.feiliupan.com/t/127891246667534336/quanwei.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/quanwei.jpg" },
                    { id: 13, title: "福拳", url: "https://d.feiliupan.com/t/127891246667534336/fuquan.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/fuquan.jpg" },
                    { id: 14, title: "我们都太年轻了，不知道福高肚大", url: "https://d.feiliupan.com/t/127891246667534336/womendoutainianqinle.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/womendoutainianqinle.jpg" },
                    { id: 15, title: "福哥对不起", url: "https://d.feiliupan.com/t/127891246667534336/fuge520.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/fuge520.jpg" },
                    { id: 16, title: "戒了烟我不习惯，没有你我怎么办", url: "https://d.feiliupan.com/t/127891246667534336/jieyan.mp4", cover: "https://d.feiliupan.com/t/127891246667534336/jieyan.jpg" }
                ],
                currentVideo: null,
                allImages: [],
                failedImages: [],
                sortedSuccessImages: [], // 按加载顺序存储成功的图片
                currentLoadIndex: 0,
                totalProcessed: 0,
                loadTimeout: null, // 视频加载超时计时器
                isMobile: false, // 是否为移动设备
                isScrolling: false // 是否正在滚动中
            },
            
            // 初始化应用
            init() {
                this.setupEventListeners();
                this.checkMobileDevice(); // 手机检测 - 移到创建视频卡片之前
                this.initializeTheme(); // 初始化主题
                this.createVideoCards();
                // 监听屏幕旋转
                window.addEventListener('orientationchange', () => {
                    this.handleOrientationChange();
                });
            },
            
            // 检测是否为移动设备
            checkMobileDevice() {
                this.state.isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (this.state.isMobile) {
                    document.body.classList.add('mobile');
                    // 移动端默认使用触摸友好的交互样式
                    this.elements.themeToggle.classList.add('touch-friendly');
                    this.elements.reloadCovers.classList.add('touch-friendly');
                    // 启用图片懒加载
                    this.setupLazyLoading();
                }
            },
            
            // 处理屏幕旋转
            handleOrientationChange() {
                // 重新应用布局
                this.applyLayout();
                
                // 延迟执行一次布局调整，确保尺寸计算准确
                setTimeout(() => {
                    this.applyLayout();
                }, 150);
                
                // 如果正在播放视频，调整播放器尺寸
                if (this.state.currentVideo) {
                    // 重置视频播放器尺寸，然后根据方向重新计算
                    this.elements.videoPlayer.style.height = 'auto';
                    setTimeout(() => {
                        // 无论什么方向，都设置为9:16比例
                        this.elements.videoPlayer.style.height = `${this.elements.videoPlayer.offsetWidth * 16 / 9}px`;
                    }, 100);
                }
            },
            
            // 设置事件监听器
            setupEventListeners() {
                // 视频卡片点击事件
                this.elements.videoGrid.addEventListener('click', (e) => {
                    const card = e.target.closest(`.${this.classes.videoCard}`);
                    if (card) {
                        const videoId = parseInt(card.dataset.videoId);
                        this.playVideo(videoId);
                    }
                });
                
                // 关闭播放器
                this.elements.closePlayer.addEventListener('click', () => this.closeVideoPlayer());
                
                // 视频播放错误处理
                this.elements.videoPlayer.addEventListener('error', (e) => this.handleVideoError(e));
                
                // 视频可以播放时隐藏加载指示器
                this.elements.videoPlayer.addEventListener('canplay', () => this.hideLoadingIndicator());
                
                // 视频数据加载完成时隐藏加载指示器
                this.elements.videoPlayer.addEventListener('loadeddata', () => this.hideLoadingIndicator());
                
                // 视频开始播放时隐藏加载指示器
                this.elements.videoPlayer.addEventListener('play', () => {
                    this.hideLoadingIndicator();
                    // 更新暂停按钮图标
                    this.updatePauseButtonIcon();
                });
                
                // 视频缓冲时显示加载指示器
                this.elements.videoPlayer.addEventListener('waiting', () => {
                    // 只有在没有错误的情况下才显示加载指示器
                    if (this.elements.videoError.classList.contains(this.classes.hidden)) {
                        this.showLoadingIndicator();
                    }
                });
                
                // 视频暂停时更新按钮图标
                this.elements.videoPlayer.addEventListener('pause', () => {
                    this.hideLoadingIndicator();
                    this.updatePauseButtonIcon();
                });
                
                // 视频结束时更新按钮图标
                this.elements.videoPlayer.addEventListener('ended', () => {
                    this.hideLoadingIndicator();
                    this.updatePauseButtonIcon();
                });
                
                // 重试播放视频
                this.elements.retryVideo.addEventListener('click', () => this.retryVideoPlayback());
                
                // 重新加载封面按钮
                this.elements.reloadCovers.addEventListener('click', () => this.reloadAllCovers());
                
                // 窗口大小变化时重新布局
                window.addEventListener('resize', () => this.applyLayout());
                
                // 主题切换
                this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());
                
                // 自定义暂停/播放按钮点击事件
                this.elements.pauseButton.addEventListener('click', () => this.togglePlayPause());
                
                // 点击视频区域也触发暂停/播放
                this.elements.videoPlayer.addEventListener('click', () => this.togglePlayPause());
                
                // 鼠标悬停在视频上时显示暂停按钮
                this.elements.videoContainer.addEventListener('mouseenter', () => {
                    this.elements.pauseButton.classList.add(this.classes.visible);
                });
                
                // 鼠标离开视频时隐藏暂停按钮
                this.elements.videoContainer.addEventListener('mouseleave', () => {
                    // 只有在视频播放时才隐藏按钮
                    if (!this.elements.videoPlayer.paused) {
                        this.elements.pauseButton.classList.remove(this.classes.visible);
                    }
                });
            },
            
            // 切换播放/暂停状态
            togglePlayPause() {
                if (this.elements.videoPlayer.paused || this.elements.videoPlayer.ended) {
                    this.elements.videoPlayer.play();
                } else {
                    this.elements.videoPlayer.pause();
                }
            },
            
            // 更新暂停按钮图标
            updatePauseButtonIcon() {
                const icon = this.elements.pauseButton.querySelector('i');
                if (this.elements.videoPlayer.paused || this.elements.videoPlayer.ended) {
                    // 视频暂停或结束时显示播放图标
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                    this.elements.pauseButton.classList.add(this.classes.visible);
                } else {
                    // 视频播放时显示暂停图标
                    icon.classList.remove('fa-play');
                    icon.classList.add('fa-pause');
                    // 鼠标不在视频上时隐藏按钮
                    if (!this.isMouseOverVideo()) {
                        this.elements.pauseButton.classList.remove(this.classes.visible);
                    }
                }
            },
            
            // 检查鼠标是否在视频上方
            isMouseOverVideo() {
                return this.elements.pauseButton.classList.contains(this.classes.visible);
            },
            
            // 平滑滚动到顶部
            scrollToTop() {
                if (this.state.isScrolling) return;
                
                this.state.isScrolling = true;
                const startPosition = window.scrollY;
                const targetPosition = 0;
                const distance = targetPosition - startPosition;
                const duration = this.config.scrollDuration;
                let startTime = null;
                
                // 使用requestAnimationFrame实现平滑滚动
                const animation = (currentTime) => {
                    if (startTime === null) startTime = currentTime;
                    const timeElapsed = currentTime - startTime;
                    const run = this.easeInOutQuad(timeElapsed, startPosition, distance, duration);
                    window.scrollTo(0, run);
                    
                    if (timeElapsed < duration) {
                        requestAnimationFrame(animation);
                    } else {
                        this.state.isScrolling = false;
                    }
                };
                
                requestAnimationFrame(animation);
            },
            
            // 缓动函数 - 使滚动更自然
            easeInOutQuad(t, b, c, d) {
                t /= d / 2;
                if (t < 1) return c / 2 * t * t + b;
                t--;
                return -c / 2 * (t * (t - 2) - 1) + b;
            },
            
            // 图片懒加载实现
            setupLazyLoading() {
                if ('IntersectionObserver' in window && this.state.isMobile) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                const src = img.dataset.src;
                                if (src) {
                                    img.src = src;
                                    img.removeAttribute('data-src');
                                }
                                observer.unobserve(img);
                            }
                        });
                    }, {
                        rootMargin: '200px 0px',
                        threshold: 0.01
                    });

                    // 监听所有视频封面
                    document.querySelectorAll('.video-cover[data-src]').forEach(img => {
                        observer.observe(img);
                    });
                }
            },
            
            // 显示加载指示器（空实现，因为已移除转圈动画）
            showLoadingIndicator() {
                // 移除了转圈动画，所以这里什么都不做
                this.elements.loadingIndicator.classList.remove(this.classes.hidden);
            },
            
            // 隐藏加载指示器
            hideLoadingIndicator() {
                this.elements.loadingIndicator.classList.add(this.classes.hidden);
                
                // 清除超时计时器
                if (this.state.loadTimeout) {
                    clearTimeout(this.state.loadTimeout);
                    this.state.loadTimeout = null;
                }
            },
            
            // 应用布局
            applyLayout() {
                const grid = this.elements.videoGrid;
                
                // 移除所有布局类
                grid.classList.remove(this.classes.grid4x4, this.classes.grid1x16, 'gap-3', 'gap-4');
                
                // 检查当前设备方向
                const isPortrait = window.innerHeight > window.innerWidth;
                
                // 根据设备类型和方向设置布局
                if (this.state.isMobile) {
                    // 手机端：无论横竖屏都是1x16布局，但添加方向感知的间距
                    grid.classList.add(this.classes.grid1x16);
                    
                    // 移除原有的gap设置，使用CSS媒体查询处理
                } else {
                    // 桌面端：横竖屏都是4x4布局
                    grid.classList.add(this.classes.grid4x4);
                    grid.classList.add('gap-4'); // 桌面端使用标准间距
                }
                
                this.adjustCardStyles();
            },
            
            // 调整卡片样式以适应不同布局
            adjustCardStyles() {
                const cards = document.querySelectorAll(`.${this.classes.videoCard}`);
                
                // 重置卡片内边距
                cards.forEach(card => {
                    card.classList.remove('p-2', 'p-3', 'p-4', 'mobile-card');
                    
                    // 根据设备类型设置卡片内边距
                    if (this.state.isMobile) {
                        card.classList.add('p-2', 'mobile-card');
                    } else {
                        card.classList.add('p-3');
                    }
                    
                    // 调整标题样式
                    const title = card.querySelector('h3');
                    if (title) {
                        title.classList.remove('text-lg', 'text-sm');
                        title.classList.add(this.state.isMobile ? 'text-sm' : 'text-base');
                    }
                    
                    // 调整播放图标样式
                    const playIcon = card.querySelector('.play-overlay i');
                    if (playIcon) {
                        playIcon.classList.toggle('mobile-play-icon', this.state.isMobile);
                    }
                });
            },
            
            // 创建视频卡片
            createVideoCards() {
                this.applyLayout();
                
                // 重置状态
                this.state.allImages = [];
                this.state.failedImages = [];
                this.state.sortedSuccessImages = [];
                this.state.currentLoadIndex = 0;
                this.state.totalProcessed = 0;
                
                // 清空网格
                this.elements.videoGrid.innerHTML = '';
                
                const fragment = document.createDocumentFragment();
                
                // 创建所有视频卡片
                this.state.videos.forEach(video => {
                    const card = this.createVideoCard(video);
                    this.state.allImages.push(this.createImageInfo(card, video));
                    fragment.appendChild(card);
                });
                
                this.elements.videoGrid.appendChild(fragment);
                
                // 设置滚动动画
                this.setupScrollAnimation();
                
                // 更新加载状态显示
                this.elements.totalItems.textContent = this.state.allImages.length;
                this.elements.globalLoading.classList.remove(this.classes.hidden);
                
                // 开始随机加载封面
                this.startRandomLoading();
            },
            
            // 创建单个视频卡片
            createVideoCard(video) {
                const card = document.createElement('div');
                card.className = `bg-white dark:bg-dark-card rounded-xl overflow-hidden shadow-lg ${this.classes.videoCard} transform transition-all ${this.classes.hidden} ${this.classes.cardEnter}`;
                card.dataset.videoId = video.id;
                
                // 视频封面容器
                const coverContainer = document.createElement('div');
                coverContainer.className = 'relative overflow-hidden rounded-lg';
                
                // 视频封面图（使用懒加载）
                const coverImg = document.createElement('img');
                coverImg.className = 'w-full aspect-9-16 object-cover rounded-lg video-cover';
                // 移动端使用懒加载，桌面端直接加载
                if (this.state.isMobile) {
                    coverImg.dataset.src = video.cover; // 使用data-src存储真实地址
                } else {
                    coverImg.src = video.cover;
                }
                coverImg.alt = video.title;
                
                // 加载指示器（已移除转圈动画）
                const coverLoading = document.createElement('div');
                coverLoading.className = this.classes.coverLoading;
                coverLoading.innerHTML = ''; // 移除了转圈动画
                
                // 错误提示
                const coverError = document.createElement('div');
                coverError.className = this.classes.coverError;
                coverError.innerHTML = `
                    <i class="fa fa-image text-2xl text-gray-500 mb-2"></i>
                    <p class="text-sm text-gray-600 dark:text-gray-400">封面加载失败</p>
                `;
                
                // 播放按钮覆盖层
                const playOverlay = document.createElement('div');
                playOverlay.className = 'play-overlay absolute inset-0 bg-black/40 flex items-center justify-center';
                playOverlay.innerHTML = '<i class="fa fa-play-circle text-white text-2xl transition-transform duration-300 hover:scale-110"></i>';
                
                // 标题
                const title = document.createElement('h3');
                title.className = 'mt-2 font-medium truncate px-1 smooth-transition';
                title.textContent = video.title;
                
                // 组装卡片
                coverContainer.appendChild(coverImg);
                coverContainer.appendChild(coverLoading);
                coverContainer.appendChild(coverError);
                coverContainer.appendChild(playOverlay);
                card.appendChild(coverContainer);
                card.appendChild(title);
                
                return card;
            },
            
            // 创建图片信息对象
            createImageInfo(card, video) {
                return {
                    card,
                    video,
                    img: card.querySelector('img'),
                    loading: card.querySelector(`.${this.classes.coverLoading}`),
                    error: card.querySelector(`.${this.classes.coverError}`),
                    loadOrder: 0, // 加载顺序，0表示未加载
                    loadTime: 0 // 加载时间戳，用于排序
                };
            },
            
            // 开始随机加载封面图片
            startRandomLoading() {
                if (this.state.currentLoadIndex >= this.state.allImages.length) {
                    // 所有图片都已尝试加载
                if (this.state.failedImages.length > 0) {
                    // 确保失败计数不超过实际视频数量
                    const displayFailedCount = Math.min(this.state.failedImages.length, this.state.videos.length);
                    this.elements.loadingText.textContent = `加载完成，${displayFailedCount}张封面加载失败`;
                    // 隐藏进度计数部分
                    this.elements.loadingProgress.style.display = 'none';
                    this.elements.totalItems.style.display = 'none';
                } else {
                        this.elements.loadingText.textContent = "全部加载完成";
                        // 隐藏进度计数部分
                        this.elements.loadingProgress.style.display = 'none';
                        this.elements.totalItems.style.display = 'none';
                    }
                    return;
                }
                
                // 随机选择一个未加载的图片
                const unloadedImages = this.state.allImages.filter((_, index) => index >= this.state.currentLoadIndex);
                const randomIndex = Math.floor(Math.random() * unloadedImages.length);
                const selectedImage = unloadedImages[randomIndex];
                
                // 将选中的图片移到当前加载位置
                const currentIndex = this.state.allImages.indexOf(selectedImage);
                [this.state.allImages[this.state.currentLoadIndex], this.state.allImages[currentIndex]] = 
                [this.state.allImages[currentIndex], this.state.allImages[this.state.currentLoadIndex]];
                
                const imageInfo = this.state.allImages[this.state.currentLoadIndex];
                this.state.currentLoadIndex++;
                
                // 记录开始加载时间
                imageInfo.loadStartTime = Date.now();
                
                // 监听图片加载事件
                imageInfo.img.onload = () => this.handleImageLoad(imageInfo);
                imageInfo.img.onerror = () => this.handleImageError(imageInfo);
                
                // 如果是移动端懒加载，这里不需要手动设置src，已通过IntersectionObserver处理
                if (!this.state.isMobile) {
                    imageInfo.img.src = imageInfo.video.cover;
                }
            },
            
            // 处理图片加载成功
            handleImageLoad(imageInfo) {
                // 记录加载完成时间
                imageInfo.loadTime = Date.now() - imageInfo.loadStartTime;
                
                imageInfo.loading.classList.add(this.classes.hidden);
                imageInfo.error.classList.add(this.classes.hidden);
                imageInfo.card.classList.remove(this.classes.hidden);
                
                // 添加到成功列表
                this.state.sortedSuccessImages.push(imageInfo);
                
                // 按加载速度排序（快的在前）
                this.reorderCardsByLoadSpeed();
                
                this.updateLoadingProgress(true);
            },
            
            // 处理图片加载失败
            handleImageError(imageInfo) {
                imageInfo.loading.classList.add(this.classes.hidden);
                imageInfo.error.classList.remove(this.classes.hidden);
                imageInfo.error.classList.add(this.classes.fadeIn);
                imageInfo.img.src = this.config.errorCoverUrl; // 显示错误图片
                imageInfo.card.classList.remove(this.classes.hidden);
                
                this.state.failedImages.push(imageInfo);
                
                // 重新排序，失败的放后面
                this.reorderCardsByLoadSpeed();
                
                this.updateLoadingProgress(true);
            },
            
            // 按加载速度重新排列卡片（快的在前，失败的在后）
            reorderCardsByLoadSpeed() {
                // 成功加载的按加载速度排序（快的在前）
                this.state.sortedSuccessImages.sort((a, b) => a.loadTime - b.loadTime);
                
                // 组合成功和失败的图片
                const allProcessed = [...this.state.sortedSuccessImages, ...this.state.failedImages];
                
                // 添加未处理的卡片到末尾
                const unprocessedImages = this.state.allImages.filter(
                    img => !allProcessed.includes(img)
                );
                
                // 重新排列DOM中的卡片
                const fragment = document.createDocumentFragment();
                allProcessed.forEach(imageInfo => {
                    fragment.appendChild(imageInfo.card);
                });
                unprocessedImages.forEach(imageInfo => {
                    fragment.appendChild(imageInfo.card);
                });
                
                // 替换网格内容
                this.elements.videoGrid.innerHTML = '';
                this.elements.videoGrid.appendChild(fragment);
            },
            
            // 设置滚动动画
            setupScrollAnimation() {
                if ('IntersectionObserver' in window) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                entry.target.classList.add(this.classes.cardEnterActive);
                                observer.unobserve(entry.target);
                            }
                        });
                    }, { threshold: 0.1 });

                    document.querySelectorAll(`.${this.classes.videoCard}`).forEach(card => {
                        observer.observe(card);
                    });
                }
            },
            
            // 更新加载进度
            updateLoadingProgress(shouldContinueLoading = false) {
                this.state.totalProcessed++;
                const progress = (this.state.totalProcessed / this.state.allImages.length) * 100;
                
                // 确保进度计数不超过实际视频数量
                const displayCount = Math.min(this.state.totalProcessed, this.state.videos.length);
                this.elements.loadingProgress.textContent = displayCount;
                this.elements.loadingBar.style.width = `${progress}%`;
                
                if (shouldContinueLoading) {
                    setTimeout(() => this.startRandomLoading(), this.config.loadDelay);
                }
            },
            
            // 重新加载所有封面
            reloadAllCovers() {
                // 添加按钮点击动画
                this.elements.reloadCovers.classList.add('animate-spin');
                setTimeout(() => {
                    this.elements.reloadCovers.classList.remove('animate-spin');
                    // 恢复进度计数元素的显示
                    this.elements.loadingProgress.style.display = 'inline';
                    this.elements.totalItems.style.display = 'inline';
                    this.createVideoCards();
                }, 500);
            },
            
            // 播放视频
            playVideo(videoId) {
                const video = this.state.videos.find(v => v.id === videoId);
                if (!video) return;
                
                this.state.currentVideo = video;
                this.elements.videoTitle.textContent = video.title;
                this.elements.videoPlayer.src = video.url;
                
                // 显示播放器并添加淡入动画
                this.elements.videoContainer.classList.remove(this.classes.hidden);
                this.elements.videoContainer.classList.add(this.classes.fadeIn);
                
                // 先滚动到顶部，再播放视频
                this.scrollToTop();
                
                // 延迟播放，等待滚动完成
                setTimeout(() => {
                    // 移动端特殊处理
                    if (this.state.isMobile) {
                        this.elements.videoContainer.classList.add('mobile-player');
                        this.elements.videoTitle.classList.add('mobile-video-title');
                        // 隐藏页面滚动
                        document.body.style.overflow = 'hidden';
                    } else {
                        this.elements.videoContainer.classList.remove('mobile-player');
                        this.elements.videoTitle.classList.remove('mobile-video-title');
                    }
                    
                    this.elements.videoError.classList.add(this.classes.hidden);
                    this.showLoadingIndicator();
                    
                    // 尝试播放视频
                    this.elements.videoPlayer.load();
                    const playPromise = this.elements.videoPlayer.play();
                    
                    // 移动端自动进入全屏
                    if (this.state.isMobile && playPromise) {
                        playPromise.then(() => {
                            if (this.elements.videoPlayer.requestFullscreen) {
                                this.elements.videoPlayer.requestFullscreen();
                            } else if (this.elements.videoPlayer.webkitRequestFullscreen) {
                                this.elements.videoPlayer.webkitRequestFullscreen();
                            }
                        }).catch(err => console.error('自动播放失败:', err));
                    }
                    
                    // 设置加载超时
                    this.state.loadTimeout = setTimeout(() => {
                        this.handleVideoTimeout();
                    }, this.config.videoLoadTimeout);
                }, this.config.scrollDuration);
            },
            
            // 关闭视频播放器
            closeVideoPlayer() {
                if (this.state.currentVideo) {
                    // 添加淡出动画
                    this.elements.videoContainer.classList.add(this.classes.fadeOut);
                    
                    setTimeout(() => {
                        this.elements.videoContainer.classList.add(this.classes.hidden);
                        this.elements.videoContainer.classList.remove(this.classes.fadeIn, this.classes.fadeOut);
                        this.elements.videoPlayer.pause();
                        this.elements.videoPlayer.src = '';
                        this.state.currentVideo = null;
                        
                        // 恢复页面滚动
                        if (this.state.isMobile) {
                            document.body.style.overflow = '';
                        }
                    }, 300); // 匹配动画时长
                    
                    this.hideLoadingIndicator();
                }
            },
            
            // 处理视频超时
            handleVideoTimeout() {
                if (this.state.currentVideo && this.elements.loadingIndicator && 
                    !this.elements.loadingIndicator.classList.contains(this.classes.hidden)) {
                    this.handleVideoError({ message: '视频加载超时，请检查网络连接' });
                }
            },
            
            // 处理视频播放错误
            handleVideoError(error) {
                this.hideLoadingIndicator();
                this.elements.videoError.classList.remove(this.classes.hidden);
                // 触发错误显示动画
                setTimeout(() => {
                    this.elements.videoError.style.opacity = '1';
                }, 10);
                
                // 根据错误类型显示不同的消息
                let errorMessage = "无法加载视频，请稍后重试";
                if (error.code === 1) errorMessage = "用户取消了视频加载";
                else if (error.code === 2) errorMessage = "视频格式不支持";
                else if (error.code === 3) errorMessage = "视频加载过程中发生错误";
                else if (error.code === 4) errorMessage = "视频地址无效或已过期";
                else if (error.message) errorMessage = error.message;
                
                this.elements.videoErrorMessage.textContent = errorMessage;
            },
            
            // 重试视频播放
            retryVideoPlayback() {
                if (!this.state.currentVideo) return;
                
                // 隐藏错误提示并添加淡出动画
                this.elements.videoError.style.opacity = '0';
                setTimeout(() => {
                    this.elements.videoError.classList.add(this.classes.hidden);
                }, 300);
                
                this.showLoadingIndicator();
                this.elements.videoPlayer.src = this.state.currentVideo.url;
                this.elements.videoPlayer.load();
                
                const playPromise = this.elements.videoPlayer.play();
                if (playPromise) {
                    playPromise.catch(err => console.error('重试播放失败:', err));
                }
                
                // 重新设置超时
                this.state.loadTimeout = setTimeout(() => {
                    this.handleVideoTimeout();
                }, this.config.videoLoadTimeout);
            },
            
            // 初始化主题
            initializeTheme() {
                // 检查本地存储中的主题偏好
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                // 应用主题
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.documentElement.classList.add('dark');
                    this.elements.themeIcon.classList.remove('fa-moon-o');
                    this.elements.themeIcon.classList.add('fa-sun-o');
                } else {
                    document.documentElement.classList.remove('dark');
                    this.elements.themeIcon.classList.remove('fa-sun-o');
                    this.elements.themeIcon.classList.add('fa-moon-o');
                }
            },
            
            // 切换主题
            toggleTheme() {
                const isDark = document.documentElement.classList.toggle('dark');
                
                // 保存主题偏好
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                
                // 更新图标
                if (isDark) {
                    this.elements.themeIcon.classList.remove('fa-moon-o');
                    this.elements.themeIcon.classList.add('fa-sun-o');
                } else {
                    this.elements.themeIcon.classList.remove('fa-sun-o');
                    this.elements.themeIcon.classList.add('fa-moon-o');
                }
            }
        };
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            VideoPlayerApp.init();
        });
    </script>

</body></html>
